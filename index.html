<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Loan Track Clientale</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #eef2f7;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    .summary {
      display: flex;
      justify-content: space-around;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .summary div { text-align: center; min-width: 120px; }
    .summary div span {
      display: block;
      font-size: 22px;
      font-weight: bold;
      margin-top: 5px;
      color: #007bff;
    }
    .form-container, .list-container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    input, select, button {
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    button:hover { background: #0056b3; }
    .client {
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .client-header {
      background: #007bff;
      color: #fff;
      padding: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s;
    }
    .client-header:hover { background: #0056b3; }
    .client-details {
      display: none;
      padding: 15px;
      background: #f9f9f9;
      border-top: 1px solid #ddd;
    }
    .client-details p { margin: 6px 0; }
    .overdue { background: #ffe5e5 !important; color: #b30000 !important; font-weight: bold; }
    .paid { background: #e5ffe5 !important; color: #008000 !important; font-weight: bold; }
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .search-box { flex: 1; min-width: 200px; }
    .remove-btn {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-top: 10px;
      transition: background 0.3s;
      width: auto;
    }
    .remove-btn:hover { background: #a71d2a; }

    @media (max-width: 900px) {
      .summary {
        flex-direction: row;
        gap: 10px;
      }
      .form-container, .list-container {
        max-width: 98vw;
        padding: 12px;
      }
    }
    @media (max-width: 600px) {
      body {
        padding: 6px;
      }
      .summary, .form-container, .list-container {
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      .summary {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .filter-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      .search-box {
        min-width: unset;
      }
      input, select, button {
        font-size: 16px;
        padding: 12px;
      }
      .client-header {
        flex-direction: column;
        align-items: flex-start;
        padding: 10px;
      }
    }
    @media (max-width: 400px) {
      h1 { font-size: 24px; }
      .summary div span { font-size: 16px; }
      input, select, button { font-size: 14px; }
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Loan Track Clientale</h1>

  <div class="summary">
    <div>Total Clients<span id="totalClients">0</span></div>
    <div>Active Loans<span id="activeLoans">0</span></div>
    <div>Overdue Loans<span id="overdueLoans">0</span></div>
    <div>Paid Loans<span id="paidLoans">0</span></div>
  </div>

  <div class="form-container">
    <h2>Add New Loan</h2>
    <form id="loanForm">
      <input type="text" id="name" placeholder="Client Name" required>
      <input type="text" id="phone" placeholder="Phone Number" required>
      <input type="number" id="amount" placeholder="Loan Amount (Kwacha)" required>
      <label>Date of Loan Application</label>
      <input type="date" id="loanDate" required>
      <label>Loan Duration (weeks)</label>
      <select id="duration" required>
        <option value="1">1 Week (10%)</option>
        <option value="2">2 Weeks (20%)</option>
        <option value="3">3 Weeks (30%)</option>
        <option value="4">4 Weeks (40%)</option>
      </select>
      <input type="text" id="collateral" placeholder="Collateral (e.g., Car, House)" required>
      <button type="submit">Add Loan</button>
    </form>
  </div>

  <div class="list-container">
    <h2>Client Loans</h2>

    <div class="filter-bar">
      <div>
        <label for="filter">Filter by Status:</label>
        <select id="filter">
          <option value="All">All</option>
          <option value="Active">Active</option>
          <option value="Overdue">Overdue</option>
          <option value="Paid">Paid</option>
        </select>
      </div>
      <div class="search-box">
        <input type="text" id="search" placeholder="Search by name or phone...">
      </div>
      <div>
        <button onclick="exportCSV()">Export CSV</button>
      </div>
    </div>

    <div id="clientList"></div>
  </div>

  <script>
    const form = document.getElementById('loanForm');
    const clientList = document.getElementById('clientList');
    const filterSelect = document.getElementById('filter');
    const searchInput = document.getElementById('search');
    const totalClientsEl = document.getElementById('totalClients');
    const activeLoansEl = document.getElementById('activeLoans');
    const overdueLoansEl = document.getElementById('overdueLoans');
    const paidLoansEl = document.getElementById('paidLoans');

    let loans = JSON.parse(localStorage.getItem('loans')) || [];

    function calculateInterest(weeks) { return weeks * 10; }
    function calculateDueDate(startDate, weeks) {
      const date = new Date(startDate);
      date.setDate(date.getDate() + (weeks * 7));
      return date.toISOString().split('T')[0];
    }
    function getStatus(loan) {
      const today = new Date();
      const dueDate = new Date(loan.dueDate);
      if (loan.paid) return 'Paid';
      if (today > dueDate) return 'Overdue';
      return 'Active';
    }
    function updateSummary() {
      let total = loans.length, active=0, overdue=0, paid=0;
      loans.forEach(loan => {
        const status = getStatus(loan);
        if(status==='Active') active++;
        else if(status==='Overdue') overdue++;
        else if(status==='Paid') paid++;
      });
      totalClientsEl.textContent = total;
      activeLoansEl.textContent = active;
      overdueLoansEl.textContent = overdue;
      paidLoansEl.textContent = paid;
    }

    function renderLoans() {
      clientList.innerHTML = '';
      const filterValue = filterSelect.value;
      const searchValue = searchInput.value.toLowerCase();

      loans.forEach((loan, index) => {
        const status = getStatus(loan);

        if (filterValue!=="All" && status!==filterValue) return;
        if(!loan.name.toLowerCase().includes(searchValue) &&
           !loan.phone.toLowerCase().includes(searchValue)) return;

        const interestAmount = (loan.amount * loan.interest)/100;
        const totalPayable = parseFloat(loan.amount)+interestAmount;

        const clientDiv = document.createElement('div');
        clientDiv.classList.add('client');

        const header = document.createElement('div');
        header.classList.add('client-header');
        header.innerHTML = `<span>${index+1}. ${loan.name}</span><span>â–¶</span>`;
        header.onclick = ()=>{
          document.querySelectorAll('.client-details').forEach(d=>{if(d!==details)d.style.display='none';});
          details.style.display = details.style.display==='block'?'none':'block';
        }

        const details = document.createElement('div');
        details.classList.add('client-details');
        if(status==='Overdue') details.classList.add('overdue');
        if(status==='Paid') details.classList.add('paid');

        details.innerHTML = `
          <p><b>Phone:</b> ${loan.phone}</p>
          <p><b>Amount:</b> K${loan.amount}</p>
          <p><b>Interest:</b> ${loan.interest}%</p>
          <p><b>Loan Date:</b> ${loan.loanDate}</p>
          <p><b>Due Date:</b> ${loan.dueDate}</p>
          <p><b>Collateral:</b> ${loan.collateral}</p>
          <p><b>Status:</b> ${status}</p>
          <p><b>Total Payable:</b> K${totalPayable.toFixed(2)}</p>
          <label><input type="checkbox" ${loan.paid?'checked':''} onchange="togglePaid(${index}, this.checked)"> Mark as Paid</label>
          <br>
          <button class="remove-btn" onclick="removeLoan(${index})">Remove Client</button>
        `;

        clientDiv.appendChild(header);
        clientDiv.appendChild(details);
        clientList.appendChild(clientDiv);
      });

      localStorage.setItem('loans', JSON.stringify(loans));
      updateSummary();
    }

    function togglePaid(index, isPaid){
      loans[index].paid = isPaid;
      renderLoans();
    }

    function removeLoan(index){
      if(confirm(`Remove loan for ${loans[index].name}?`)){
        loans.splice(index,1);
        renderLoans();
      }
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const weeks = parseInt(document.getElementById('duration').value);
      const interest = calculateInterest(weeks);
      const loanDate = document.getElementById('loanDate').value;
      const dueDate = calculateDueDate(loanDate, weeks);

      const newLoan = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        amount: document.getElementById('amount').value,
        interest: interest,
        loanDate: loanDate,
        dueDate: dueDate,
        collateral: document.getElementById('collateral').value,
        paid: false
      };

      loans.push(newLoan);
      renderLoans();
      form.reset();
    });

    filterSelect.addEventListener('change', renderLoans);
    searchInput.addEventListener('input', renderLoans);

    function exportCSV(){
      if(!confirm("Download loan records as CSV?")) return;

      let csv = "Name,Phone,Amount (Kwacha),Interest,Loan Date,Due Date,Collateral,Status,Total Payable (Kwacha)\n";
      loans.forEach(loan=>{
        const status = getStatus(loan);
        const interestAmount = (loan.amount * loan.interest)/100;
        const totalPayable = parseFloat(loan.amount)+interestAmount;
        csv += `${loan.name},${loan.phone},K${loan.amount},${loan.interest},${loan.loanDate},${loan.dueDate},${loan.collateral},${status},K${totalPayable.toFixed(2)}\n`;
      });

      const blob = new Blob([csv], {type:'text/csv'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "loans.csv";
      link.click();
    }

    renderLoans();
  </script>
</body>
  </html>
